<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>todogether.io – Listname</title>
     
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="//code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
    <script>
        var socket = io.connect()
        var thisList = {}
        var listItemCount = 0;
        thisList.HTMLcontent = $('.lists').html()
        thisList.ID = window.location.pathname;

        /* Connect */
        socket.on('connect', function() {
            socket.emit('getListData', thisList.ID);
            socket.on('getJSON', function(listJSON) {
                if (listJSON.HTMLcontent != '') {
                    thisList.HTMLcontent = listJSON.HTMLcontent
                    $('.lists').html(thisList.HTMLcontent)

                    $('.list-item').each(function() {
                        listItemCount++;
                    })
                    console.log('There are currently ' + listItemCount + ' list items!');
                }
            });

            socket.emit('newUser', thisList.ID);
        })

        /* Status Updates */

        socket.on('updateLog', function(status) {
            $('.log').append('<li>' + status + '</li>');
        });

        socket.on('updateUsers', function(userCount) {
            $('.users').html(userCount);
        });

        /* Checklist */ 

        function saveList() {
            thisList.HTMLcontent = $('.lists').html();
            socket.emit('saveList', thisList)
            console.log(thisList);
        }

        socket.on('saveListTrigger', function() {
            saveList();
        });

        socket.on('updateList', function(data) {
            if(typeof(data) == 'string') {
                listItemCount++,
                $('.list-todo').prepend('<li><input type="checkbox" class="checkbox-todo"><span itemID="' + listItemCount + '"class="list-item" contenteditable>' + data + '</span></li>');
                console.log('Item added');
            } else {
                $('.lists').html(data.HTMLcontent); 
                console.log('Content replaced' +  data.HTMLcontent);
            };

            thisList.HTMLcontent = $('.lists').html();
            saveList();
        });

        $(function() {
            // $('.save').click(function() {
            //     saveList();
            // });

            $('.datasend').click(function() {
                var data = $('.data').val();
                $('.data').val('');
                socket.emit('addItem', data);
            });

            $('.data').keypress(function(e) {
                if (e.which == 13) {
                    $('.datasend').click().blur();
                }
            });

            function updateItem(thisElement) {
                var itemContent = thisElement.html();
                var itemID = thisElement.attr('itemID');
                socket.emit('updateItem', itemID, itemContent)
            }

            socket.on('showItemUpdate', function(itemID, itemContent) {
                $('.list-item[itemID = "' + itemID + '"]').html(itemContent);
                $('.list-item[itemID = "' + itemID + '"]').clearQueue().animate({'color': 'red'}, 100).animate({'color': 'black'}, 1000);
                console.log('ITEM ' + itemID + ' UPDATED');
                console.log($('.list-item[itemID = "' + itemID + '"]').html());
            });

            $('.lists')
                .on('click', '.list-item', function() {
                    var itemContentBackup = $(this).html();
                    $(this).addClass('active');
                    $(this).keydown( function(e) {
                        console.log(e.which);
                        saveList();
                        if (e.which == 13) {
                            // updateEntireList();
                            $(this).blur();

                        }
                    });

                    $(this).keyup( function(e) {
                        if (e.which == 27) {
                            // updateEntireList();
                            $(this).html(itemContentBackup);
                            console.log('ESCAPE');
                            $(this).blur();
                        }
                    });
                    
                })
                .on('blur', '.list-item', function() {
                    $(this).removeClass('active');
                    saveList();
                })
                .on('keyup', '.list-item', function() {
                    updateItem($(this));
                });

            $('.lists').on('click', '.list-todo .checkbox-todo', function() {
                $(this).attr('checked', 'checked');
                var thisListItem = $(this).parent('li');
                $('.list-done').prepend('<li>' + thisListItem.html() + '</li>');
                thisListItem.remove();
                updateEntireList();
                console.log('check');
                
            })

            $('.lists').on('click', '.list-done .checkbox-todo', function() {
                console.log('uncheck');
                $(this).removeAttr('checked');
                var thisListItem = $(this).parent('li');
                $('.list-todo').prepend('<li>' + thisListItem.html() + '</li>');
                thisListItem.remove();
                updateEntireList()
            })

            function updateEntireList() {
                thisList.HTMLcontent = $('.lists').html();
                socket.emit('coldUpdate', thisList)
            }
        });

    </script>
    <link rel="stylesheet" href="/css/style.css" type="text/css" />

</head>
<body>

<div>
    <h1><a href="#">todogether.io</a></h1>
    <ul>
        <li><a href="#">Create a new list</a></li>
        <li><a href="#">Feature Request</a></li>
        <li><a href="#">Help</a></li>
    </ul>
</div>
<div>
    <h2>Listname</h2>
    <p>Your unique list-adress: <span class="list-url">todogether.io/AS_DMjsa</span></p>

    <div>
        <h3>INFO</h3>
        <ul>
            <li>Created: 2014-01-12 9:32</li>
            <li>Last edit: 2014-01-12 - 18.17</li>
            <li>List items: 27 (3/24)</li>
        </ul>
    </div>

    <div>
        <h3>ONLINE:</h3>
        <ul class="users">1</ul>
        <h3>STATUS:</h3>
        <ul class="log"></ul>
    </div>

    <div>
        <h3>SHARE:</h3>
        <ul>
            <li><a href="#">Mail</a></li>
            <li><a href="#">Copy URL</a></li>
        </ul>
    </div>

    <div>
        <h3>EXPORT:</h3>
        <ul>
            <li><a href="#">Plain Text</a></li>
            <li><a href="#">JSON</a></li>
            <!-- <li><a href="#">other format?</a></li> -->
        </ul>
    </div>

    <div>
      <input class="data"/>
      <input type="button" class="datasend" value="add" />
      <div class="lists">
        <h3>TO DO</h3>
        <ul class="list-todo"></ul>
        <h3>COMPLETED</h3>
        <ul class="list-done"></ul>
      </div>
    </div>
</div>

<div>
    <p>
        Feel free to <a href="mailtp:philipp@todogether.io">contact me</a>. – Built with – Visit this project at <a href="https://github.com/axani/todogether.io">GitHub</a>
    </p>
</div>

</body>
</html>
