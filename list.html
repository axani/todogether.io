<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>todogether.io – Listname</title>
     
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="//code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
    <script>
        var socket = io.connect()
        var thisList = {}
        var listItemCount = 0;
        thisList.HTMLcontent = $('.sub-lists').html()
        thisList.ID = window.location.pathname;

        /* Connect */
        socket.on('connect', function() {
            socket.emit('getListData', thisList.ID);
            socket.on('getJSON', function(listJSON) {
                if (listJSON.HTMLcontent != '') {
                    thisList.HTMLcontent = listJSON.HTMLcontent
                    $('.sub-lists').html(thisList.HTMLcontent)

                    $('.list-item').each(function() {
                        listItemCount++;
                    })
                    console.log('There are currently ' + listItemCount + ' list items!');
                }
            });

            socket.emit('newUser', thisList.ID);
        })

        /* Status Updates */

        socket.on('updateLog', function(status) {
            $('.log').append('<li>' + status + '</li>');
        });

        socket.on('updateUsers', function(userCount) {
            $('.users').html(userCount);
        });

        /* Checklist */ 

        function saveList() {
            thisList.HTMLcontent = $('.sub-lists').html();
            socket.emit('saveList', thisList)
            console.log(thisList);
        }

        socket.on('saveListTrigger', function() {
            saveList();
        });

        socket.on('updateList', function(data) {
            if(typeof(data) == 'string') {
                listItemCount++,
                $('.list-todo').prepend('<li><input type="checkbox" class="checkbox-todo"><span itemID="' + listItemCount + '"class="list-item" contenteditable>' + data + '</span></li>');
                console.log('Item added');
            } else {
                $('.sub-lists').html(data.HTMLcontent); 
                console.log('Content replaced' +  data.HTMLcontent);
            };

            thisList.HTMLcontent = $('.sub-lists').html();
            saveList();
        });

        $(function() {
            // $('.save').click(function() {
            //     saveList();
            // });

            $('.datasend').click(function() {
                var data = $('.list-input').val();
                $('.list-input').val('');
                socket.emit('addItem', data);
            });

            $('.list-input').keypress(function(e) {
                if (e.which == 13) {
                    $('.datasend').click().blur();
                }
            });

            function updateItem(thisElement) {
                var itemContent = thisElement.html();
                var itemID = thisElement.attr('itemID');
                socket.emit('updateItem', itemID, itemContent)
            }

            socket.on('showItemUpdate', function(itemID, itemContent) {
                $('.list-item[itemID = "' + itemID + '"]').html(itemContent);
                $('.list-item[itemID = "' + itemID + '"]').clearQueue().animate({'color': 'red'}, 100).animate({'color': 'black'}, 1000);
                console.log('ITEM ' + itemID + ' UPDATED');
                console.log($('.list-item[itemID = "' + itemID + '"]').html());
            });

            $('.sub-lists')
                .on('click', '.list-item', function() {
                    var itemContentBackup = $(this).html();
                    $(this).addClass('active');
                    $(this).keydown( function(e) {
                        console.log(e.which);
                        saveList();
                        if (e.which == 13) {
                            // updateEntireList();
                            $(this).blur();

                        }
                    });

                    $(this).keyup( function(e) {
                        if (e.which == 27) {
                            // updateEntireList();
                            $(this).html(itemContentBackup);
                            console.log('ESCAPE');
                            $(this).blur();
                        }
                    });
                    
                })
                .on('blur', '.list-item', function() {
                    $(this).removeClass('active');
                    saveList();
                })
                .on('keyup', '.list-item', function() {
                    updateItem($(this));
                });

            $('.sub-lists').on('click', '.list-todo .checkbox-todo', function() {
                $(this).attr('checked', 'checked');
                var thisListItem = $(this).parent('li');
                $('.list-done').prepend('<li>' + thisListItem.html() + '</li>');
                thisListItem.remove();
                updateEntireList();
                console.log('check');
                
            })

            $('.sub-lists').on('click', '.list-done .checkbox-todo', function() {
                console.log('uncheck');
                $(this).removeAttr('checked');
                var thisListItem = $(this).parent('li');
                $('.list-todo').prepend('<li>' + thisListItem.html() + '</li>');
                thisListItem.remove();
                updateEntireList()
            })

            function updateEntireList() {
                thisList.HTMLcontent = $('.sub-lists').html();
                socket.emit('coldUpdate', thisList)
            }
        });

    </script>
    <link rel="stylesheet" href="/css/style.css" type="text/css" />

</head>
<body>

<div class="header">
    <h1><a href="#" class="unstyled-link">todogether.io</a></h1>
    <ul>
        <li><a href="#">Create a new list</a></li>
        <li><a href="#">Feature Request</a></li>
        <li><a href="#">Help</a></li>
    </ul>
</div>
<div class="list">

    <h2 class="list-name">Listname</h2>
    <p>Your unique list-address: <a href='#' class="list-url">todogether.io/AS_DMjsa</a></p>
    
    <div class="input-area">
        <input class="list-input edit-border"/><a href="#" class="datasend list-input-button">+</a>
    </div>

    <div class="list-main">

        <div class="sub-lists">
            <h3>To do</h3>
            <ul class="list-todo"></ul>
            <h3>Done</h3>
            <ul class="list-done"></ul>
        </div>
    </div>

    <div class="list-footer">
        <div class="list-info">
            <!-- <h3>INFO</h3> -->
            <h3>Created:</h3> 01.12.2014 9:32<br>
            <h3>Last edit:</h3> 01.12.2014 18:17<br>
            <h3>List items:</h3> 27 (3/24)<br>
            <h3>Active users:</h3> <span class="users">1</span>
            <!-- <h3>STATUS:</h3>
            <ul class="log"></ul> -->
        </div>
        
        <div class="list-output">
            <div>
                <h3>Share:</h3>
                <ul>
                    <li><a href="#">Mail</a></li>
                    <li><a href="#">Copy URL</a></li>
                </ul>
            </div>

            <div>
                <h3>Export:</h3>
                <ul>
                    <li><a href="#">Plain Text</a></li>
                    <li><a href="#">JSON</a></li>
                    <!-- <li><a href="#">other format?</a></li> -->
                </ul>
            </div>
        </div>
    </div>

    
</div>

<div class="footer">
    <p>
        Feel free to <a href="mailtp:philipp@todogether.io">contact me</a>. – Built with – Visit this project at <a href="https://github.com/axani/todogether.io">GitHub</a>
    </p>
</div>

</body>
</html>
